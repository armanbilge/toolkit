<!DOCTYPE html>
<html lang="en">
  
  <head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="generator" content="Laika 0.19.0 + Helium Theme" />
  <title>Examples</title>
  
  <meta name="author" content="toolkit contributors"/>
  
  
  <meta name="description" content="docs"/>
  
  
  
  <link rel="icon" sizes="32x32" type="image/png" href="https://typelevel.org/img/favicon.png"/>
  
  
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700">
  
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Fira+Mono:500">
  
  <link rel="stylesheet" type="text/css" href="helium/icofont.min.css" />
    <link rel="stylesheet" type="text/css" href="helium/laika-helium.css" />
  <script src="helium/laika-helium.js"></script>
  
  
  <script> /* for avoiding page load transitions */ </script>
</head>

  <body>

    <header id="top-bar">

  <div class="row">
    <a id="nav-icon">
      <i class="icofont-laika navigationMenu" title="Navigation">&#xefa2;</i>
    </a>
    
    
  </div>

  <a class="image-link" href="https://typelevel.org"><img src="https://typelevel.org/img/logo.svg"></a>

  <div class="row links">
    
    <a class="icon-link svg-link" href="https://github.com/armanbilge/toolkit"><span class="github" title="Source Code"><svg class="svg-icon" width="100%" height="100%" viewBox="0 0 100 100" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" xmlns:serif="http://www.serif.com/" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;">
  <g class="svg-shape">
    <path d="M49.995,1c-27.609,-0 -49.995,22.386 -49.995,50.002c-0,22.09 14.325,40.83 34.194,47.444c2.501,0.458 3.413,-1.086 3.413,-2.412c0,-1.185 -0.043,-4.331 -0.067,-8.503c-13.908,3.021 -16.843,-6.704 -16.843,-6.704c-2.274,-5.773 -5.552,-7.311 -5.552,-7.311c-4.54,-3.103 0.344,-3.042 0.344,-3.042c5.018,0.356 7.658,5.154 7.658,5.154c4.46,7.64 11.704,5.433 14.552,4.156c0.454,-3.232 1.744,-5.436 3.174,-6.685c-11.102,-1.262 -22.775,-5.553 -22.775,-24.713c-0,-5.457 1.949,-9.92 5.147,-13.416c-0.516,-1.265 -2.231,-6.348 0.488,-13.233c0,0 4.199,-1.344 13.751,5.126c3.988,-1.108 8.266,-1.663 12.518,-1.682c4.245,0.019 8.523,0.574 12.517,1.682c9.546,-6.47 13.736,-5.126 13.736,-5.126c2.728,6.885 1.013,11.968 0.497,13.233c3.204,3.496 5.141,7.959 5.141,13.416c0,19.209 -11.691,23.436 -22.83,24.673c1.795,1.544 3.394,4.595 3.394,9.26c0,6.682 -0.061,12.076 -0.061,13.715c0,1.338 0.899,2.894 3.438,2.406c19.853,-6.627 34.166,-25.354 34.166,-47.438c-0,-27.616 -22.389,-50.002 -50.005,-50.002"/>
  </g>
</svg></span></a>
    
    <a class="icon-link glyph-link" href="https://discord.gg/XF3CXcMzqD"><i class="icofont-laika chat" title="Chat">&#xeed5;</i></a>
    
    <a class="icon-link glyph-link" href="https://twitter.com/typelevel"><i class="icofont-laika twitter" title="Twitter">&#xed7a;</i></a>
    
  </div>  

</header>
    
    <nav id="sidebar">

  <div class="row">
    
    <a class="icon-link svg-link" href="https://github.com/armanbilge/toolkit"><span class="github" title="Source Code"><svg class="svg-icon" width="100%" height="100%" viewBox="0 0 100 100" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" xmlns:serif="http://www.serif.com/" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;">
  <g class="svg-shape">
    <path d="M49.995,1c-27.609,-0 -49.995,22.386 -49.995,50.002c-0,22.09 14.325,40.83 34.194,47.444c2.501,0.458 3.413,-1.086 3.413,-2.412c0,-1.185 -0.043,-4.331 -0.067,-8.503c-13.908,3.021 -16.843,-6.704 -16.843,-6.704c-2.274,-5.773 -5.552,-7.311 -5.552,-7.311c-4.54,-3.103 0.344,-3.042 0.344,-3.042c5.018,0.356 7.658,5.154 7.658,5.154c4.46,7.64 11.704,5.433 14.552,4.156c0.454,-3.232 1.744,-5.436 3.174,-6.685c-11.102,-1.262 -22.775,-5.553 -22.775,-24.713c-0,-5.457 1.949,-9.92 5.147,-13.416c-0.516,-1.265 -2.231,-6.348 0.488,-13.233c0,0 4.199,-1.344 13.751,5.126c3.988,-1.108 8.266,-1.663 12.518,-1.682c4.245,0.019 8.523,0.574 12.517,1.682c9.546,-6.47 13.736,-5.126 13.736,-5.126c2.728,6.885 1.013,11.968 0.497,13.233c3.204,3.496 5.141,7.959 5.141,13.416c0,19.209 -11.691,23.436 -22.83,24.673c1.795,1.544 3.394,4.595 3.394,9.26c0,6.682 -0.061,12.076 -0.061,13.715c0,1.338 0.899,2.894 3.438,2.406c19.853,-6.627 34.166,-25.354 34.166,-47.438c-0,-27.616 -22.389,-50.002 -50.005,-50.002"/>
  </g>
</svg></span></a>
    
    <a class="icon-link glyph-link" href="https://discord.gg/XF3CXcMzqD"><i class="icofont-laika chat" title="Chat">&#xeed5;</i></a>
    
    <a class="icon-link glyph-link" href="https://twitter.com/typelevel"><i class="icofont-laika twitter" title="Twitter">&#xed7a;</i></a>
    
  </div>

  <ul class="nav-list">
    <li class="level1 nav-leaf"><a href="index.html">typelevel-toolkit</a></li>
    <li class="level1 active nav-leaf"><a href="#">Examples</a></li>
    <li class="level1 nav-header">tutorial</li>
    <li class="level2 nav-leaf"><a href="tutorial/cats-effect.html">Cats and Cats Effect</a></li>
    <li class="level1 nav-header">Related Projects</li>
    <li class="level2 nav-leaf"><a href="https://typelevel.org/cats">Cats</a></li>
    <li class="level2 nav-leaf"><a href="https://typelevel.org/cats-effect">Cats Effect</a></li>
    <li class="level2 nav-leaf"><a href="https://fs2.io">FS2</a></li>
    <li class="level2 nav-leaf"><a href="https://http4s.org">http4s</a></li>
    <li class="level2 nav-leaf"><a href="https://circe.github.io/circe">Circe</a></li>
    <li class="level2 nav-leaf"><a href="https://fs2-data.gnieh.org/">fs2-data</a></li>
    <li class="level2 nav-leaf"><a href="http://monovore.com/decline/">Decline</a></li>
    <li class="level2 nav-leaf"><a href="https://typelevel.org/munit-cats-effect/">MUnit Cats Effect</a></li>
  </ul>

</nav>

    <div id="container">

      
<nav id="page-nav">
  <p class="header"><a href="#">Examples</a></p>

  <ul class="nav-list">
    <li class="level1 nav-leaf"><a href="#posting-data-and-writing-the-response-to-a-file">POSTing data and writing the response to a file</a></li>
    <li class="level1 nav-leaf"><a href="#command-line-version-of-mkstring">Command line version of mkString</a></li>
    <li class="level1 nav-leaf"><a href="#parsing-and-transforming-a-csv-file">Parsing and transforming a CSV file</a></li>
    <li class="level1 nav-leaf"><a href="#parsing-and-transforming-raw-data">Parsing and transforming raw data</a></li>
  </ul>

  <p class="footer"></p>
</nav>


      <main class="content">

        <h1 id="examples" class="title">Examples</h1>
        <p>This page contains examples of how typelevel-toolkit and <a href="https://scala-cli.virtuslab.org/">Scala CLI</a> work together to write single file scripts using all the power of the Typelevel&#39;s libraries.</p>
        
        <h2 id="posting-data-and-writing-the-response-to-a-file" class="section"><a class="anchor-link left" href="#posting-data-and-writing-the-response-to-a-file"><i class="icofont-laika link">&#xef71;</i></a>POSTing data and writing the response to a file</h2>
        <p>This example was written by <a href="https://github.com/Koroeskohr">Koroeskohr</a> and taken from the <a href="https://virtuslab.com/blog/scala-toolkit-makes-scala-powerful-straight-out-of-the-box/">Virtuslab Blog</a>.</p>
        <div class="tab-container" data-tab-group="scala-version">
          <ul class="tab-group">
            <li class="tab active" data-choice-name="scala-3"><a href="#">Scala 3</a></li>
            <li class="tab" data-choice-name="scala-2"><a href="#">Scala 2</a></li>
          </ul>
          <div class="tab-content active" data-choice-name="scala-3">
            <pre><code class="nohighlight"><span class="comment">//&gt; using lib &quot;org.typelevel::toolkit::0.0.11&quot;
</span><span>
</span><span class="keyword">import</span><span> </span><span class="identifier">cats</span><span>.</span><span class="identifier">effect</span><span>.*
</span><span class="keyword">import</span><span> </span><span class="identifier">io</span><span>.</span><span class="identifier">circe</span><span>.</span><span class="type-name">Decoder</span><span>
</span><span class="keyword">import</span><span> </span><span class="identifier">fs2</span><span>.</span><span class="type-name">Stream</span><span>
</span><span class="keyword">import</span><span> </span><span class="identifier">fs2</span><span>.</span><span class="identifier">io</span><span>.</span><span class="identifier">file</span><span>.*
</span><span class="keyword">import</span><span> </span><span class="identifier">org</span><span>.</span><span class="identifier">http4s</span><span>.</span><span class="identifier">ember</span><span>.</span><span class="identifier">client</span><span>.*
</span><span class="keyword">import</span><span> </span><span class="identifier">org</span><span>.</span><span class="identifier">http4s</span><span>.*
</span><span class="keyword">import</span><span> </span><span class="identifier">org</span><span>.</span><span class="identifier">http4s</span><span>.</span><span class="identifier">implicits</span><span>.*
</span><span class="keyword">import</span><span> </span><span class="identifier">org</span><span>.</span><span class="identifier">http4s</span><span>.</span><span class="identifier">circe</span><span>.*

</span><span class="keyword">object</span><span> </span><span class="type-name">Main</span><span> </span><span class="keyword">extends</span><span> </span><span class="type-name">IOApp</span><span>.</span><span class="type-name">Simple</span><span>:
  </span><span class="keyword">case</span><span> </span><span class="keyword">class</span><span> </span><span class="type-name">Data</span><span>(</span><span class="identifier">value</span><span>: </span><span class="type-name">String</span><span>)
  </span><span class="keyword">given</span><span> </span><span class="type-name">Decoder</span><span>[</span><span class="type-name">Data</span><span>]           = </span><span class="type-name">Decoder</span><span>.</span><span class="identifier">forProduct1</span><span>(</span><span class="string-literal">&quot;data&quot;</span><span>)(</span><span class="type-name">Data</span><span>.</span><span class="identifier">apply</span><span>)
  </span><span class="keyword">given</span><span> </span><span class="type-name">EntityDecoder</span><span>[</span><span class="type-name">IO</span><span>, </span><span class="type-name">Data</span><span>] = </span><span class="identifier">jsonOf</span><span>[</span><span class="type-name">IO</span><span>, </span><span class="type-name">Data</span><span>]

  </span><span class="keyword">def</span><span> </span><span class="declaration-name">run</span><span> = </span><span class="type-name">EmberClientBuilder</span><span>.</span><span class="identifier">default</span><span>[</span><span class="type-name">IO</span><span>].</span><span class="identifier">build</span><span>.</span><span class="identifier">use</span><span> { </span><span class="identifier">client</span><span> =&gt;
    </span><span class="keyword">val</span><span> </span><span class="identifier">request</span><span>: </span><span class="type-name">Request</span><span>[</span><span class="type-name">IO</span><span>] =
      </span><span class="type-name">Request</span><span>(</span><span class="type-name">Method</span><span>.</span><span class="type-name">POST</span><span>, </span><span class="string-literal">uri&quot;https://httpbin.org/anything&quot;</span><span>)
        .</span><span class="identifier">withEntity</span><span>(</span><span class="string-literal">&quot;file.txt bunchofdata&quot;</span><span>)

    </span><span class="identifier">client</span><span>
      .</span><span class="identifier">expect</span><span>[</span><span class="type-name">Data</span><span>](</span><span class="identifier">request</span><span>)
      .</span><span class="identifier">map</span><span>(</span><span class="identifier">_</span><span>.</span><span class="identifier">value</span><span>.</span><span class="identifier">split</span><span>(</span><span class="string-literal">&quot; &quot;</span><span>))
      .</span><span class="identifier">flatMap</span><span> { </span><span class="keyword">case</span><span> </span><span class="type-name">Array</span><span>(</span><span class="identifier">fileName</span><span>, </span><span class="identifier">content</span><span>) =&gt;
        </span><span class="type-name">IO</span><span>.</span><span class="identifier">println</span><span>(</span><span class="string-literal">s&quot;Writing data to </span><span class="substitution">$fileName</span><span class="string-literal">&quot;</span><span>) *&gt;
          </span><span class="type-name">Stream</span><span>(</span><span class="identifier">content</span><span>)
            .</span><span class="identifier">through</span><span>(</span><span class="identifier">fs2</span><span>.</span><span class="identifier">text</span><span>.</span><span class="identifier">utf8</span><span>.</span><span class="identifier">encode</span><span>)
            .</span><span class="identifier">through</span><span>(</span><span class="type-name">Files</span><span>[</span><span class="type-name">IO</span><span>].</span><span class="identifier">writeAll</span><span>(</span><span class="type-name">Path</span><span>(</span><span class="identifier">fileName</span><span>)))
            .</span><span class="identifier">compile</span><span>
            .</span><span class="identifier">drain</span><span>
      }
  }</span></code></pre>
          </div>
          <div class="tab-content" data-choice-name="scala-2">
            <pre><code class="nohighlight"><span class="comment">//&gt; using lib &quot;org.typelevel::toolkit::0.0.11&quot;
</span><span>
</span><span class="keyword">import</span><span> </span><span class="identifier">cats</span><span>.</span><span class="identifier">effect</span><span>.</span><span class="identifier">_</span><span>
</span><span class="keyword">import</span><span> </span><span class="identifier">io</span><span>.</span><span class="identifier">circe</span><span>.</span><span class="type-name">Decoder</span><span>
</span><span class="keyword">import</span><span> </span><span class="identifier">fs2</span><span>.</span><span class="type-name">Stream</span><span>
</span><span class="keyword">import</span><span> </span><span class="identifier">fs2</span><span>.</span><span class="identifier">io</span><span>.</span><span class="identifier">file</span><span>.</span><span class="identifier">_</span><span>
</span><span class="keyword">import</span><span> </span><span class="identifier">org</span><span>.</span><span class="identifier">http4s</span><span>.</span><span class="identifier">ember</span><span>.</span><span class="identifier">client</span><span>.</span><span class="identifier">_</span><span>
</span><span class="keyword">import</span><span> </span><span class="identifier">org</span><span>.</span><span class="identifier">http4s</span><span>.</span><span class="identifier">_</span><span>
</span><span class="keyword">import</span><span> </span><span class="identifier">org</span><span>.</span><span class="identifier">http4s</span><span>.</span><span class="identifier">implicits</span><span>.</span><span class="identifier">_</span><span>
</span><span class="keyword">import</span><span> </span><span class="identifier">org</span><span>.</span><span class="identifier">http4s</span><span>.</span><span class="identifier">circe</span><span>.</span><span class="identifier">_</span><span>

</span><span class="keyword">object</span><span> </span><span class="type-name">Main</span><span> </span><span class="keyword">extends</span><span> </span><span class="type-name">IOApp</span><span>.</span><span class="type-name">Simple</span><span> {
  </span><span class="keyword">case</span><span> </span><span class="keyword">class</span><span> </span><span class="type-name">Data</span><span>(</span><span class="identifier">value</span><span>: </span><span class="type-name">String</span><span>)
  </span><span class="keyword">implicit</span><span> </span><span class="keyword">val</span><span> </span><span class="identifier">json</span><span>: </span><span class="type-name">Decoder</span><span>[</span><span class="type-name">Data</span><span>]          = </span><span class="type-name">Decoder</span><span>.</span><span class="identifier">forProduct1</span><span>(</span><span class="string-literal">&quot;data&quot;</span><span>)(</span><span class="type-name">Data</span><span>.</span><span class="identifier">apply</span><span>)
  </span><span class="keyword">implicit</span><span> </span><span class="keyword">val</span><span> </span><span class="identifier">enc</span><span>: </span><span class="type-name">EntityDecoder</span><span>[</span><span class="type-name">IO</span><span>, </span><span class="type-name">Data</span><span>] = </span><span class="identifier">jsonOf</span><span>[</span><span class="type-name">IO</span><span>, </span><span class="type-name">Data</span><span>]

  </span><span class="keyword">def</span><span> </span><span class="declaration-name">run</span><span> = </span><span class="type-name">EmberClientBuilder</span><span>.</span><span class="identifier">default</span><span>[</span><span class="type-name">IO</span><span>].</span><span class="identifier">build</span><span>.</span><span class="identifier">use</span><span> { </span><span class="identifier">client</span><span> =&gt;
    </span><span class="keyword">val</span><span> </span><span class="identifier">request</span><span>: </span><span class="type-name">Request</span><span>[</span><span class="type-name">IO</span><span>] =
      </span><span class="type-name">Request</span><span>(</span><span class="type-name">Method</span><span>.</span><span class="type-name">POST</span><span>, </span><span class="string-literal">uri&quot;https://httpbin.org/anything&quot;</span><span>)
        .</span><span class="identifier">withEntity</span><span>(</span><span class="string-literal">&quot;file.txt bunchofdata&quot;</span><span>)

    </span><span class="identifier">client</span><span>
      .</span><span class="identifier">expect</span><span>[</span><span class="type-name">Data</span><span>](</span><span class="identifier">request</span><span>)
      .</span><span class="identifier">map</span><span>(</span><span class="identifier">_</span><span>.</span><span class="identifier">value</span><span>.</span><span class="identifier">split</span><span>(</span><span class="string-literal">&quot; &quot;</span><span>))
      .</span><span class="identifier">flatMap</span><span> { </span><span class="keyword">case</span><span> </span><span class="type-name">Array</span><span>(</span><span class="identifier">fileName</span><span>, </span><span class="identifier">content</span><span>) =&gt;
        </span><span class="type-name">IO</span><span>.</span><span class="identifier">println</span><span>(</span><span class="string-literal">s&quot;Writing data to </span><span class="substitution">$fileName</span><span class="string-literal">&quot;</span><span>) *&gt;
          </span><span class="type-name">Stream</span><span>(</span><span class="identifier">content</span><span>)
            .</span><span class="identifier">through</span><span>(</span><span class="identifier">fs2</span><span>.</span><span class="identifier">text</span><span>.</span><span class="identifier">utf8</span><span>.</span><span class="identifier">encode</span><span>)
            .</span><span class="identifier">through</span><span>(</span><span class="type-name">Files</span><span>[</span><span class="type-name">IO</span><span>].</span><span class="identifier">writeAll</span><span>(</span><span class="type-name">Path</span><span>(</span><span class="identifier">fileName</span><span>)))
            .</span><span class="identifier">compile</span><span>
            .</span><span class="identifier">drain</span><span>
      }
  }
}</span></code></pre>
          </div>
        </div>
        
        <h2 id="command-line-version-of-mkstring" class="section"><a class="anchor-link left" href="#command-line-version-of-mkstring"><i class="icofont-laika link">&#xef71;</i></a>Command line version of mkString</h2>
        <p>In this example, <a href="https://fs2.io/#/">fs2</a> is used to read a stream of newline delimited strings from standard input and to reconcatenate them with comma by default, while <a href="https://ben.kirw.in/decline/">decline</a> is leveraged to parse the command line options.</p>
        <p>Compiling this example with <a href="https://scala-native.org/en/stable/">scala-native</a>, adding these directives</p>
        <pre class="keep-together pdf epub"><code class="nohighlight"><span class="comment">//&gt; using packaging.output &quot;mkString&quot;
//&gt; using platform &quot;native&quot;
//&gt; using nativeMode &quot;release-fast&quot;</span></code></pre>
        <p>will produce a native executable that can be used in a similar way as the Scala&#39;s standard library <code>.mkString</code>:</p>
        <pre class="keep-together pdf epub"><code class="sh">$ echo -e &quot;foo\nbar&quot; | ./mkString --prefix &quot;[&quot; -d &quot;,&quot; --suffix &quot;]&quot;
// [foo,bar]</code></pre>
        <div class="tab-container" data-tab-group="scala-version">
          <ul class="tab-group">
            <li class="tab active" data-choice-name="scala-3"><a href="#">Scala 3</a></li>
            <li class="tab" data-choice-name="scala-2"><a href="#">Scala 2</a></li>
          </ul>
          <div class="tab-content active" data-choice-name="scala-3">
            <pre><code class="nohighlight"><span class="comment">//&gt; using lib &quot;org.typelevel::toolkit::0.0.11&quot;
</span><span>
</span><span class="keyword">import</span><span> </span><span class="identifier">cats</span><span>.</span><span class="identifier">effect</span><span>.*
</span><span class="keyword">import</span><span> </span><span class="identifier">cats</span><span>.</span><span class="identifier">syntax</span><span>.</span><span class="identifier">all</span><span>.*
</span><span class="keyword">import</span><span> </span><span class="identifier">com</span><span>.</span><span class="identifier">monovore</span><span>.</span><span class="identifier">decline</span><span>.*
</span><span class="keyword">import</span><span> </span><span class="identifier">com</span><span>.</span><span class="identifier">monovore</span><span>.</span><span class="identifier">decline</span><span>.</span><span class="identifier">effect</span><span>.*
</span><span class="keyword">import</span><span> </span><span class="identifier">fs2</span><span>.*
</span><span class="keyword">import</span><span> </span><span class="identifier">fs2</span><span>.</span><span class="identifier">io</span><span>.*

</span><span class="keyword">val</span><span> </span><span class="identifier">prefix</span><span>    = </span><span class="type-name">Opts</span><span>.</span><span class="identifier">option</span><span>[</span><span class="type-name">String</span><span>](</span><span class="string-literal">&quot;prefix&quot;</span><span>, </span><span class="string-literal">&quot;&quot;</span><span>).</span><span class="identifier">withDefault</span><span>(</span><span class="string-literal">&quot;&quot;</span><span>)
</span><span class="keyword">val</span><span> </span><span class="identifier">delimiter</span><span> = </span><span class="type-name">Opts</span><span>.</span><span class="identifier">option</span><span>[</span><span class="type-name">String</span><span>](</span><span class="string-literal">&quot;delimiter&quot;</span><span>, </span><span class="string-literal">&quot;&quot;</span><span>, </span><span class="string-literal">&quot;d&quot;</span><span>).</span><span class="identifier">withDefault</span><span>(</span><span class="string-literal">&quot;,&quot;</span><span>)
</span><span class="keyword">val</span><span> </span><span class="identifier">suffix</span><span>    = </span><span class="type-name">Opts</span><span>.</span><span class="identifier">option</span><span>[</span><span class="type-name">String</span><span>](</span><span class="string-literal">&quot;suffix&quot;</span><span>, </span><span class="string-literal">&quot;The suffix&quot;</span><span>).</span><span class="identifier">withDefault</span><span>(</span><span class="string-literal">&quot;&quot;</span><span>)

</span><span class="keyword">val</span><span> </span><span class="identifier">stringStream</span><span>: </span><span class="type-name">Stream</span><span>[</span><span class="type-name">IO</span><span>, </span><span class="type-name">String</span><span>] = </span><span class="identifier">stdinUtf8</span><span>[</span><span class="type-name">IO</span><span>](</span><span class="number-literal">1024</span><span> * </span><span class="number-literal">1024</span><span> * </span><span class="number-literal">10</span><span>)
  .</span><span class="identifier">repartition</span><span>(</span><span class="identifier">s</span><span> =&gt; </span><span class="type-name">Chunk</span><span>.</span><span class="identifier">array</span><span>(</span><span class="identifier">s</span><span>.</span><span class="identifier">split</span><span>(</span><span class="string-literal">&quot;</span><span class="escape-sequence">\n</span><span class="string-literal">&quot;</span><span>, -</span><span class="number-literal">1</span><span>)))
  .</span><span class="identifier">filter</span><span>(</span><span class="identifier">_</span><span>.</span><span class="identifier">nonEmpty</span><span>)

</span><span class="comment">// inspired by list.mkString
</span><span class="keyword">object</span><span> </span><span class="type-name">Main</span><span> </span><span class="keyword">extends</span><span> </span><span class="type-name">CommandIOApp</span><span>(</span><span class="string-literal">&quot;mkString&quot;</span><span>, </span><span class="string-literal">&quot;Concatenates strings from stdin&quot;</span><span>):
  </span><span class="keyword">def</span><span> </span><span class="declaration-name">main</span><span> = (</span><span class="identifier">prefix</span><span>, </span><span class="identifier">delimiter</span><span>, </span><span class="identifier">suffix</span><span>).</span><span class="identifier">mapN</span><span> { (</span><span class="identifier">pre</span><span>, </span><span class="identifier">delim</span><span>, </span><span class="identifier">post</span><span>) =&gt;
    </span><span class="keyword">val</span><span> </span><span class="identifier">stream</span><span> = </span><span class="type-name">Stream</span><span>(</span><span class="identifier">pre</span><span>) ++ </span><span class="identifier">stringStream</span><span>.</span><span class="identifier">intersperse</span><span>(</span><span class="identifier">delim</span><span>) ++ </span><span class="type-name">Stream</span><span>(</span><span class="identifier">post</span><span>)
    </span><span class="identifier">stream</span><span>.</span><span class="identifier">foreach</span><span>(</span><span class="type-name">IO</span><span>.</span><span class="identifier">print</span><span>).</span><span class="identifier">compile</span><span>.</span><span class="identifier">drain</span><span>.</span><span class="identifier">as</span><span>(</span><span class="type-name">ExitCode</span><span>.</span><span class="type-name">Success</span><span>)
  }</span></code></pre>
          </div>
          <div class="tab-content" data-choice-name="scala-2">
            <pre><code class="nohighlight"><span class="comment">//&gt; using lib &quot;org.typelevel::toolkit::0.0.11&quot;
</span><span>
</span><span class="keyword">import</span><span> </span><span class="identifier">cats</span><span>.</span><span class="identifier">effect</span><span>.</span><span class="identifier">_</span><span>
</span><span class="keyword">import</span><span> </span><span class="identifier">cats</span><span>.</span><span class="identifier">syntax</span><span>.</span><span class="identifier">all</span><span>.</span><span class="identifier">_</span><span>
</span><span class="keyword">import</span><span> </span><span class="identifier">com</span><span>.</span><span class="identifier">monovore</span><span>.</span><span class="identifier">decline</span><span>.</span><span class="identifier">_</span><span>
</span><span class="keyword">import</span><span> </span><span class="identifier">com</span><span>.</span><span class="identifier">monovore</span><span>.</span><span class="identifier">decline</span><span>.</span><span class="identifier">effect</span><span>.</span><span class="identifier">_</span><span>
</span><span class="keyword">import</span><span> </span><span class="identifier">fs2</span><span>.</span><span class="identifier">_</span><span>
</span><span class="keyword">import</span><span> </span><span class="identifier">fs2</span><span>.</span><span class="identifier">io</span><span>.</span><span class="identifier">_</span><span>

</span><span class="comment">// inspired by list.mkString
</span><span class="keyword">object</span><span> </span><span class="type-name">Main</span><span> </span><span class="keyword">extends</span><span> </span><span class="type-name">CommandIOApp</span><span>(</span><span class="string-literal">&quot;mkString&quot;</span><span>, </span><span class="string-literal">&quot;Concatenates strings from stdin&quot;</span><span>) {
  </span><span class="keyword">val</span><span> </span><span class="identifier">prefix</span><span>    = </span><span class="type-name">Opts</span><span>.</span><span class="identifier">option</span><span>[</span><span class="type-name">String</span><span>](</span><span class="string-literal">&quot;prefix&quot;</span><span>, </span><span class="string-literal">&quot;&quot;</span><span>).</span><span class="identifier">withDefault</span><span>(</span><span class="string-literal">&quot;&quot;</span><span>)
  </span><span class="keyword">val</span><span> </span><span class="identifier">delimiter</span><span> = </span><span class="type-name">Opts</span><span>.</span><span class="identifier">option</span><span>[</span><span class="type-name">String</span><span>](</span><span class="string-literal">&quot;delimiter&quot;</span><span>, </span><span class="string-literal">&quot;&quot;</span><span>, </span><span class="string-literal">&quot;d&quot;</span><span>).</span><span class="identifier">withDefault</span><span>(</span><span class="string-literal">&quot;,&quot;</span><span>)
  </span><span class="keyword">val</span><span> </span><span class="identifier">suffix</span><span>    = </span><span class="type-name">Opts</span><span>.</span><span class="identifier">option</span><span>[</span><span class="type-name">String</span><span>](</span><span class="string-literal">&quot;suffix&quot;</span><span>, </span><span class="string-literal">&quot;The suffix&quot;</span><span>).</span><span class="identifier">withDefault</span><span>(</span><span class="string-literal">&quot;&quot;</span><span>)

  </span><span class="keyword">val</span><span> </span><span class="identifier">stringStream</span><span>: </span><span class="type-name">Stream</span><span>[</span><span class="type-name">IO</span><span>, </span><span class="type-name">String</span><span>] = </span><span class="identifier">stdinUtf8</span><span>[</span><span class="type-name">IO</span><span>](</span><span class="number-literal">1024</span><span> * </span><span class="number-literal">1024</span><span> * </span><span class="number-literal">10</span><span>)
    .</span><span class="identifier">repartition</span><span>(</span><span class="identifier">s</span><span> =&gt; </span><span class="type-name">Chunk</span><span>.</span><span class="identifier">array</span><span>(</span><span class="identifier">s</span><span>.</span><span class="identifier">split</span><span>(</span><span class="string-literal">&quot;</span><span class="escape-sequence">\n</span><span class="string-literal">&quot;</span><span>, -</span><span class="number-literal">1</span><span>)))
    .</span><span class="identifier">filter</span><span>(</span><span class="identifier">_</span><span>.</span><span class="identifier">nonEmpty</span><span>)

  </span><span class="keyword">def</span><span> </span><span class="declaration-name">main</span><span> = (</span><span class="identifier">prefix</span><span>, </span><span class="identifier">delimiter</span><span>, </span><span class="identifier">suffix</span><span>).</span><span class="identifier">mapN</span><span> { (</span><span class="identifier">pre</span><span>, </span><span class="identifier">delim</span><span>, </span><span class="identifier">post</span><span>) =&gt;
    </span><span class="keyword">val</span><span> </span><span class="identifier">stream</span><span> = </span><span class="type-name">Stream</span><span>(</span><span class="identifier">pre</span><span>) ++ </span><span class="identifier">stringStream</span><span>.</span><span class="identifier">intersperse</span><span>(</span><span class="identifier">delim</span><span>) ++ </span><span class="type-name">Stream</span><span>(</span><span class="identifier">post</span><span>)
    </span><span class="identifier">stream</span><span>.</span><span class="identifier">foreach</span><span>(</span><span class="type-name">IO</span><span>.</span><span class="identifier">print</span><span>).</span><span class="identifier">compile</span><span>.</span><span class="identifier">drain</span><span>.</span><span class="identifier">as</span><span>(</span><span class="type-name">ExitCode</span><span>.</span><span class="type-name">Success</span><span>)
  }
}</span></code></pre>
          </div>
        </div>
        
        <h2 id="parsing-and-transforming-a-csv-file" class="section"><a class="anchor-link left" href="#parsing-and-transforming-a-csv-file"><i class="icofont-laika link">&#xef71;</i></a>Parsing and transforming a CSV file</h2>
        <p>Here, <a href="https://fs2-data.gnieh.org/documentation/csv/">fs2-data-csv</a> is used to read and parse a comma separated file. 
        Manual encoders and decoders are defined for our <code>Passenger</code>s to show you how to do everything from scratch.</p>
        <p>Let&#39;s start with a CSV file that has records of fictious passengers registered for a flight:</p>
        <pre><code>id,First Name,Age,flight number,destination
1,Seyton,44,WX122,Tanzania
2,Lina,,UX199,Greenland
3,Grogu,,SW999,Singapore</code></pre>
        <div class="tab-container" data-tab-group="scala-version">
          <ul class="tab-group">
            <li class="tab active" data-choice-name="scala-3"><a href="#">Scala 3</a></li>
            <li class="tab" data-choice-name="scala-2"><a href="#">Scala 2</a></li>
          </ul>
          <div class="tab-content active" data-choice-name="scala-3">
            <pre><code class="nohighlight"><span class="comment">//&gt; using lib &quot;org.typelevel::toolkit::0.0.11&quot;
</span><span>
</span><span class="keyword">import</span><span> </span><span class="identifier">cats</span><span>.</span><span class="identifier">effect</span><span>.*
</span><span class="keyword">import</span><span> </span><span class="identifier">fs2</span><span>.</span><span class="identifier">text</span><span>
</span><span class="keyword">import</span><span> </span><span class="identifier">fs2</span><span>.</span><span class="identifier">data</span><span>.</span><span class="identifier">csv</span><span>.*
</span><span class="keyword">import</span><span> </span><span class="identifier">fs2</span><span>.</span><span class="identifier">data</span><span>.</span><span class="identifier">csv</span><span>.</span><span class="identifier">generic</span><span>.</span><span class="identifier">semiauto</span><span>.*
</span><span class="keyword">import</span><span> </span><span class="identifier">fs2</span><span>.</span><span class="identifier">io</span><span>.</span><span class="identifier">file</span><span>.{</span><span class="type-name">Path</span><span>, </span><span class="type-name">Flags</span><span>, </span><span class="type-name">Files</span><span>}
</span><span class="keyword">import</span><span> </span><span class="identifier">cats</span><span>.</span><span class="identifier">data</span><span>.</span><span class="type-name">NonEmptyList</span><span>

</span><span class="keyword">case</span><span> </span><span class="keyword">class</span><span> </span><span class="type-name">Passenger</span><span>(
    </span><span class="identifier">id</span><span>: </span><span class="type-name">Long</span><span>,
    </span><span class="identifier">firstName</span><span>: </span><span class="type-name">String</span><span>,
    </span><span class="identifier">age</span><span>: </span><span class="type-name">Either</span><span>[</span><span class="type-name">String</span><span>, </span><span class="type-name">Int</span><span>],
    </span><span class="identifier">flightNumber</span><span>: </span><span class="type-name">String</span><span>,
    </span><span class="identifier">destination</span><span>: </span><span class="type-name">String</span><span>
)

</span><span class="keyword">object</span><span> </span><span class="type-name">Passenger</span><span>:
  </span><span class="comment">// Here we define a manual decoder for each row in our CSV
</span><span>  </span><span class="keyword">given</span><span> </span><span class="identifier">csvRowDecoder</span><span>: </span><span class="type-name">CsvRowDecoder</span><span>[</span><span class="type-name">Passenger</span><span>, </span><span class="type-name">String</span><span>] </span><span class="keyword">with</span><span>
    </span><span class="keyword">def</span><span> </span><span class="declaration-name">apply</span><span>(</span><span class="identifier">row</span><span>: </span><span class="type-name">CsvRow</span><span>[</span><span class="type-name">String</span><span>]): </span><span class="type-name">DecoderResult</span><span>[</span><span class="type-name">Passenger</span><span>] =
      </span><span class="keyword">for</span><span>
        </span><span class="identifier">id</span><span> &lt;- </span><span class="identifier">row</span><span>.</span><span class="identifier">as</span><span>[</span><span class="type-name">Long</span><span>](</span><span class="string-literal">&quot;id&quot;</span><span>)
        </span><span class="identifier">firstName</span><span> &lt;- </span><span class="identifier">row</span><span>.</span><span class="identifier">as</span><span>[</span><span class="type-name">String</span><span>](</span><span class="string-literal">&quot;First Name&quot;</span><span>)
        </span><span class="identifier">ageOpt</span><span> &lt;- </span><span class="identifier">row</span><span>.</span><span class="identifier">asOptional</span><span>[</span><span class="type-name">Int</span><span>](</span><span class="string-literal">&quot;Age&quot;</span><span>)
        </span><span class="identifier">flightNumber</span><span> &lt;- </span><span class="identifier">row</span><span>.</span><span class="identifier">as</span><span>[</span><span class="type-name">String</span><span>](</span><span class="string-literal">&quot;flight number&quot;</span><span>)
        </span><span class="identifier">destination</span><span> &lt;- </span><span class="identifier">row</span><span>.</span><span class="identifier">as</span><span>[</span><span class="type-name">String</span><span>](</span><span class="string-literal">&quot;destination&quot;</span><span>)
      </span><span class="keyword">yield</span><span>
        </span><span class="keyword">val</span><span> </span><span class="identifier">age</span><span> = </span><span class="identifier">ageOpt</span><span>.</span><span class="identifier">toRight</span><span>[</span><span class="type-name">String</span><span>](</span><span class="string-literal">&quot;N/A&quot;</span><span>)
        </span><span class="type-name">Passenger</span><span>(</span><span class="identifier">id</span><span>, </span><span class="identifier">firstName</span><span>, </span><span class="identifier">age</span><span>, </span><span class="identifier">flightNumber</span><span>, </span><span class="identifier">destination</span><span>)

    </span><span class="comment">// Here we define a manual encoder for encoding Passenger classes to a CSV
</span><span>    </span><span class="keyword">given</span><span> </span><span class="identifier">csvRowEncoder</span><span>: </span><span class="type-name">CsvRowEncoder</span><span>[</span><span class="type-name">Passenger</span><span>, </span><span class="type-name">String</span><span>] </span><span class="keyword">with</span><span>
      </span><span class="keyword">def</span><span> </span><span class="declaration-name">apply</span><span>(</span><span class="identifier">p</span><span>: </span><span class="type-name">Passenger</span><span>): </span><span class="type-name">CsvRow</span><span>[</span><span class="type-name">String</span><span>] =
        </span><span class="type-name">CsvRow</span><span>.</span><span class="identifier">fromNelHeaders</span><span>(
          </span><span class="type-name">NonEmptyList</span><span>.</span><span class="identifier">of</span><span>(
            (</span><span class="identifier">p</span><span>.</span><span class="identifier">firstName</span><span>, </span><span class="string-literal">&quot;first_name&quot;</span><span>),
            (</span><span class="identifier">p</span><span>.</span><span class="identifier">age</span><span>.</span><span class="identifier">toString</span><span>(), </span><span class="string-literal">&quot;age&quot;</span><span>),
            (</span><span class="identifier">p</span><span>.</span><span class="identifier">flightNumber</span><span>, </span><span class="string-literal">&quot;flight_number&quot;</span><span>),
            (</span><span class="identifier">p</span><span>.</span><span class="identifier">destination</span><span>, </span><span class="string-literal">&quot;destination&quot;</span><span>)
          )
        )

</span><span class="keyword">val</span><span> </span><span class="identifier">input</span><span> = </span><span class="type-name">Files</span><span>[</span><span class="type-name">IO</span><span>]
  .</span><span class="identifier">readAll</span><span>(</span><span class="type-name">Path</span><span>(</span><span class="string-literal">&quot;./example.csv&quot;</span><span>), </span><span class="number-literal">1024</span><span>, </span><span class="type-name">Flags</span><span>.</span><span class="type-name">Read</span><span>)
  .</span><span class="identifier">through</span><span>(</span><span class="identifier">text</span><span>.</span><span class="identifier">utf8</span><span>.</span><span class="identifier">decode</span><span>)
  .</span><span class="identifier">through</span><span>(</span><span class="identifier">decodeUsingHeaders</span><span>[</span><span class="type-name">Passenger</span><span>]())

</span><span class="keyword">object</span><span> </span><span class="type-name">CSVPrinter</span><span> </span><span class="keyword">extends</span><span> </span><span class="type-name">IOApp</span><span>.</span><span class="type-name">Simple</span><span>:

  </span><span class="comment">/** First we&#39;ll do some logging for each row, 
    * and then calculate and print the mean age */</span><span>
  </span><span class="keyword">val</span><span> </span><span class="identifier">run</span><span> =
    </span><span class="identifier">input</span><span>
      .</span><span class="identifier">evalTap</span><span>(</span><span class="identifier">p</span><span> =&gt;
        </span><span class="type-name">IO</span><span>.</span><span class="identifier">println</span><span>(
          </span><span class="string-literal">s&quot;</span><span class="substitution">${p.firstName}</span><span class="string-literal"> is taking flight: </span><span class="substitution">${p.flightNumber}</span><span class="string-literal"> to </span><span class="substitution">${p.destination}</span><span class="string-literal">&quot;</span><span>
        )
      )
      .</span><span class="identifier">collect</span><span>({ </span><span class="keyword">case</span><span> </span><span class="type-name">Passenger</span><span>(</span><span class="identifier">_</span><span>, </span><span class="identifier">_</span><span>, </span><span class="type-name">Right</span><span>(</span><span class="identifier">age</span><span>), </span><span class="identifier">_</span><span>, </span><span class="identifier">_</span><span>) =&gt; </span><span class="identifier">age</span><span> })
      .</span><span class="identifier">foldMap</span><span>(</span><span class="identifier">age</span><span> =&gt; (</span><span class="identifier">age</span><span>, </span><span class="number-literal">1</span><span>))
      .</span><span class="identifier">compile</span><span>
      .</span><span class="identifier">lastOrError</span><span>
      .</span><span class="identifier">flatMap</span><span>((</span><span class="identifier">sum</span><span>, </span><span class="identifier">count</span><span>) =&gt;
        </span><span class="type-name">IO</span><span>.</span><span class="identifier">println</span><span>(</span><span class="string-literal">s&quot;The mean age of the passengers is </span><span class="substitution">${sum / count}</span><span class="string-literal">&quot;</span><span>)
      )</span></code></pre>
          </div>
          <div class="tab-content" data-choice-name="scala-2">
            <pre><code class="nohighlight"><span class="comment">//&gt; using lib &quot;org.typelevel::toolkit::0.0.11&quot;
</span><span>
</span><span class="keyword">import</span><span> </span><span class="identifier">cats</span><span>.</span><span class="identifier">effect</span><span>.</span><span class="identifier">_</span><span>
</span><span class="keyword">import</span><span> </span><span class="identifier">fs2</span><span>.</span><span class="identifier">text</span><span>
</span><span class="keyword">import</span><span> </span><span class="identifier">fs2</span><span>.</span><span class="identifier">data</span><span>.</span><span class="identifier">csv</span><span>.</span><span class="identifier">_</span><span>
</span><span class="keyword">import</span><span> </span><span class="identifier">fs2</span><span>.</span><span class="identifier">data</span><span>.</span><span class="identifier">csv</span><span>.</span><span class="identifier">generic</span><span>.</span><span class="identifier">semiauto</span><span>.</span><span class="identifier">_</span><span>
</span><span class="keyword">import</span><span> </span><span class="identifier">fs2</span><span>.</span><span class="identifier">io</span><span>.</span><span class="identifier">file</span><span>.{</span><span class="type-name">Path</span><span>, </span><span class="type-name">Flags</span><span>, </span><span class="type-name">Files</span><span>}
</span><span class="keyword">import</span><span> </span><span class="identifier">cats</span><span>.</span><span class="identifier">data</span><span>.</span><span class="type-name">NonEmptyList</span><span>

</span><span class="keyword">case</span><span> </span><span class="keyword">class</span><span> </span><span class="type-name">Passenger</span><span>(
    </span><span class="identifier">id</span><span>: </span><span class="type-name">Long</span><span>,
    </span><span class="identifier">firstName</span><span>: </span><span class="type-name">String</span><span>,
    </span><span class="identifier">age</span><span>: </span><span class="type-name">Either</span><span>[</span><span class="type-name">String</span><span>, </span><span class="type-name">Int</span><span>],
    </span><span class="identifier">flightNumber</span><span>: </span><span class="type-name">String</span><span>,
    </span><span class="identifier">destination</span><span>: </span><span class="type-name">String</span><span>
)

</span><span class="keyword">object</span><span> </span><span class="type-name">Passenger</span><span> {
  </span><span class="comment">// Here we define a manual decoder for each row in our CSV
</span><span>  </span><span class="keyword">implicit</span><span> </span><span class="keyword">val</span><span> </span><span class="identifier">csvRowDecoder</span><span>: </span><span class="type-name">CsvRowDecoder</span><span>[</span><span class="type-name">Passenger</span><span>, </span><span class="type-name">String</span><span>] =
    </span><span class="keyword">new</span><span> </span><span class="type-name">CsvRowDecoder</span><span>[</span><span class="type-name">Passenger</span><span>, </span><span class="type-name">String</span><span>] {
      </span><span class="keyword">def</span><span> </span><span class="declaration-name">apply</span><span>(</span><span class="identifier">row</span><span>: </span><span class="type-name">CsvRow</span><span>[</span><span class="type-name">String</span><span>]): </span><span class="type-name">DecoderResult</span><span>[</span><span class="type-name">Passenger</span><span>] =
        </span><span class="keyword">for</span><span> {
          </span><span class="identifier">id</span><span> &lt;- </span><span class="identifier">row</span><span>.</span><span class="identifier">as</span><span>[</span><span class="type-name">Long</span><span>](</span><span class="string-literal">&quot;id&quot;</span><span>)
          </span><span class="identifier">firstName</span><span> &lt;- </span><span class="identifier">row</span><span>.</span><span class="identifier">as</span><span>[</span><span class="type-name">String</span><span>](</span><span class="string-literal">&quot;First Name&quot;</span><span>)
          </span><span class="identifier">ageOpt</span><span> &lt;- </span><span class="identifier">row</span><span>.</span><span class="identifier">asOptional</span><span>[</span><span class="type-name">Int</span><span>](</span><span class="string-literal">&quot;Age&quot;</span><span>)
          </span><span class="identifier">flightNumber</span><span> &lt;- </span><span class="identifier">row</span><span>.</span><span class="identifier">as</span><span>[</span><span class="type-name">String</span><span>](</span><span class="string-literal">&quot;flight number&quot;</span><span>)
          </span><span class="identifier">destination</span><span> &lt;- </span><span class="identifier">row</span><span>.</span><span class="identifier">as</span><span>[</span><span class="type-name">String</span><span>](</span><span class="string-literal">&quot;destination&quot;</span><span>)
        } </span><span class="keyword">yield</span><span> {
          </span><span class="keyword">val</span><span> </span><span class="identifier">age</span><span> = </span><span class="identifier">ageOpt</span><span>.</span><span class="identifier">toRight</span><span>[</span><span class="type-name">String</span><span>](</span><span class="string-literal">&quot;N/A&quot;</span><span>)
          </span><span class="type-name">Passenger</span><span>(</span><span class="identifier">id</span><span>, </span><span class="identifier">firstName</span><span>, </span><span class="identifier">age</span><span>, </span><span class="identifier">flightNumber</span><span>, </span><span class="identifier">destination</span><span>)
        }
    }

  </span><span class="comment">// Here we define a manual encoder for encoding Passenger classes to a CSV
</span><span>  </span><span class="keyword">implicit</span><span> </span><span class="keyword">val</span><span> </span><span class="identifier">csvRowEncoder</span><span>: </span><span class="type-name">CsvRowEncoder</span><span>[</span><span class="type-name">Passenger</span><span>, </span><span class="type-name">String</span><span>] =
    </span><span class="keyword">new</span><span> </span><span class="type-name">CsvRowEncoder</span><span>[</span><span class="type-name">Passenger</span><span>, </span><span class="type-name">String</span><span>] {
      </span><span class="keyword">def</span><span> </span><span class="declaration-name">apply</span><span>(</span><span class="identifier">p</span><span>: </span><span class="type-name">Passenger</span><span>): </span><span class="type-name">CsvRow</span><span>[</span><span class="type-name">String</span><span>] =
        </span><span class="type-name">CsvRow</span><span>.</span><span class="identifier">fromNelHeaders</span><span>(
          </span><span class="type-name">NonEmptyList</span><span>.</span><span class="identifier">of</span><span>(
            (</span><span class="identifier">p</span><span>.</span><span class="identifier">firstName</span><span>, </span><span class="string-literal">&quot;first_name&quot;</span><span>),
            (</span><span class="identifier">p</span><span>.</span><span class="identifier">age</span><span>.</span><span class="identifier">toString</span><span>(), </span><span class="string-literal">&quot;age&quot;</span><span>),
            (</span><span class="identifier">p</span><span>.</span><span class="identifier">flightNumber</span><span>, </span><span class="string-literal">&quot;flight_number&quot;</span><span>),
            (</span><span class="identifier">p</span><span>.</span><span class="identifier">destination</span><span>, </span><span class="string-literal">&quot;destination&quot;</span><span>)
          )
        )
    }
}

</span><span class="keyword">object</span><span> </span><span class="type-name">CSVPrinter</span><span> </span><span class="keyword">extends</span><span> </span><span class="type-name">IOApp</span><span>.</span><span class="type-name">Simple</span><span> {
  </span><span class="keyword">val</span><span> </span><span class="identifier">input</span><span> = </span><span class="type-name">Files</span><span>[</span><span class="type-name">IO</span><span>]
    .</span><span class="identifier">readAll</span><span>(</span><span class="type-name">Path</span><span>(</span><span class="string-literal">&quot;./example.csv&quot;</span><span>), </span><span class="number-literal">1024</span><span>, </span><span class="type-name">Flags</span><span>.</span><span class="type-name">Read</span><span>)
    .</span><span class="identifier">through</span><span>(</span><span class="identifier">text</span><span>.</span><span class="identifier">utf8</span><span>.</span><span class="identifier">decode</span><span>)
    .</span><span class="identifier">through</span><span>(</span><span class="identifier">decodeUsingHeaders</span><span>[</span><span class="type-name">Passenger</span><span>]())


  </span><span class="comment">/** First we&#39;ll do some logging for each row, 
    * and then calculate and print the mean age */</span><span>
  </span><span class="keyword">val</span><span> </span><span class="identifier">run</span><span> =
    </span><span class="identifier">input</span><span>
      .</span><span class="identifier">evalTap</span><span>(</span><span class="identifier">p</span><span> =&gt;
        </span><span class="type-name">IO</span><span>.</span><span class="identifier">println</span><span>(
          </span><span class="string-literal">s&quot;</span><span class="substitution">${p.firstName}</span><span class="string-literal"> is taking flight: </span><span class="substitution">${p.flightNumber}</span><span class="string-literal"> to </span><span class="substitution">${p.destination}</span><span class="string-literal">&quot;</span><span>
        )
      )
      .</span><span class="identifier">collect</span><span>({ </span><span class="keyword">case</span><span> </span><span class="type-name">Passenger</span><span>(</span><span class="identifier">_</span><span>, </span><span class="identifier">_</span><span>, </span><span class="type-name">Right</span><span>(</span><span class="identifier">age</span><span>), </span><span class="identifier">_</span><span>, </span><span class="identifier">_</span><span>) =&gt; </span><span class="identifier">age</span><span> })
      .</span><span class="identifier">foldMap</span><span>(</span><span class="identifier">age</span><span> =&gt; (</span><span class="identifier">age</span><span>, </span><span class="number-literal">1</span><span>))
      .</span><span class="identifier">compile</span><span>
      .</span><span class="identifier">lastOrError</span><span>
      .</span><span class="identifier">flatMap</span><span>({ </span><span class="keyword">case</span><span> (</span><span class="identifier">sum</span><span>, </span><span class="identifier">count</span><span>) =&gt;
        </span><span class="type-name">IO</span><span>.</span><span class="identifier">println</span><span>(</span><span class="string-literal">s&quot;The mean age of the passengers is </span><span class="substitution">${sum / count}</span><span class="string-literal">&quot;</span><span>)
      })
}</span></code></pre>
          </div>
        </div>
        
        <h2 id="parsing-and-transforming-raw-data" class="section"><a class="anchor-link left" href="#parsing-and-transforming-raw-data"><i class="icofont-laika link">&#xef71;</i></a>Parsing and transforming raw data</h2>
        <p>This real world example was written by <a href="https://github.com/lenguyenthanh">Thanh Le</a> to convert a file for the <a href="https://github.com/lichess-org/scalachess">scalachess library</a>. The file is used for testing the correctness of its legal moves generator.</p>
        <p>Start with an input file named <code>fischer.epd</code> containing:</p>
        <pre><code>bqnb1rkr/pp3ppp/3ppn2/2p5/5P2/P2P4/NPP1P1PP/BQ1BNRKR w HFhf - 2 9 ;D1 21 ;D2 528 ;D3 12189 ;D4 326672 ;D5 8146062 ;D6 227689589</code></pre>
        <p>The result will be a <code>chess960.perft</code> containing:</p>
        <pre><code>id 0
epd bqnb1rkr/pp3ppp/3ppn2/2p5/5P2/P2P4/NPP1P1PP/BQ1BNRKR w HFhf - 2 9
perft 1 21
perft 2 528
perft 3 12189
perft 4 326672
perft 5 8146062
perft 6 227689589</code></pre>
        <div class="tab-container" data-tab-group="scala-version">
          <ul class="tab-group">
            <li class="tab active" data-choice-name="scala-3"><a href="#">Scala 3</a></li>
            <li class="tab" data-choice-name="scala-2"><a href="#">Scala 2</a></li>
          </ul>
          <div class="tab-content active" data-choice-name="scala-3">
            <pre><code class="nohighlight"><span class="comment">//&gt; using lib &quot;org.typelevel::toolkit::0.0.11&quot;
</span><span>
</span><span class="keyword">import</span><span> </span><span class="identifier">cats</span><span>.</span><span class="identifier">effect</span><span>.{</span><span class="type-name">IO</span><span>, </span><span class="type-name">IOApp</span><span>}
</span><span class="keyword">import</span><span> </span><span class="identifier">fs2</span><span>.{</span><span class="type-name">Stream</span><span>, </span><span class="identifier">text</span><span>}
</span><span class="keyword">import</span><span> </span><span class="identifier">fs2</span><span>.</span><span class="identifier">io</span><span>.</span><span class="identifier">file</span><span>.{</span><span class="type-name">Files</span><span>, </span><span class="type-name">Path</span><span>}

</span><span class="keyword">object</span><span> </span><span class="type-name">PerftConverter</span><span> </span><span class="keyword">extends</span><span> </span><span class="type-name">IOApp</span><span>.</span><span class="type-name">Simple</span><span>:

  </span><span class="keyword">val</span><span> </span><span class="identifier">converter</span><span>: </span><span class="type-name">Stream</span><span>[</span><span class="type-name">IO</span><span>, </span><span class="type-name">Unit</span><span>] =
    </span><span class="keyword">def</span><span> </span><span class="declaration-name">raw2Perft</span><span>(</span><span class="identifier">id</span><span>: </span><span class="type-name">Long</span><span>, </span><span class="identifier">raw</span><span>: </span><span class="type-name">String</span><span>): </span><span class="type-name">String</span><span> =
      </span><span class="keyword">val</span><span> </span><span class="identifier">list</span><span> = </span><span class="identifier">raw</span><span>.</span><span class="identifier">split</span><span>(</span><span class="string-literal">&quot;;&quot;</span><span>).</span><span class="identifier">zipWithIndex</span><span>.</span><span class="identifier">map</span><span> {
        </span><span class="keyword">case</span><span> (</span><span class="identifier">epd</span><span>, </span><span class="number-literal">0</span><span>) =&gt; </span><span class="string-literal">s&quot;epd </span><span class="substitution">${epd}</span><span class="string-literal">&quot;</span><span>
        </span><span class="keyword">case</span><span> (</span><span class="identifier">s</span><span>, </span><span class="identifier">i</span><span>)   =&gt; </span><span class="string-literal">s&quot;perft </span><span class="substitution">$i</span><span class="string-literal"> </span><span class="substitution">${s.split(&quot; &quot;)(1)}</span><span class="string-literal">&quot;</span><span>
      }
      </span><span class="identifier">list</span><span>.</span><span class="identifier">mkString</span><span>(</span><span class="string-literal">s&quot;id </span><span class="substitution">$id</span><span class="escape-sequence">\n</span><span class="string-literal">&quot;</span><span>, </span><span class="string-literal">&quot;</span><span class="escape-sequence">\n</span><span class="string-literal">&quot;</span><span>, </span><span class="string-literal">&quot;</span><span class="escape-sequence">\n</span><span class="string-literal">&quot;</span><span>)

    </span><span class="type-name">Files</span><span>[</span><span class="type-name">IO</span><span>]
      .</span><span class="identifier">readUtf8Lines</span><span>(</span><span class="type-name">Path</span><span>(</span><span class="string-literal">&quot;fischer.epd&quot;</span><span>))
      .</span><span class="identifier">filter</span><span>(</span><span class="identifier">s</span><span> =&gt; !</span><span class="identifier">s</span><span>.</span><span class="identifier">trim</span><span>.</span><span class="identifier">isEmpty</span><span>)
      .</span><span class="identifier">zipWithIndex</span><span>
      .</span><span class="identifier">map</span><span>((</span><span class="identifier">x</span><span>, </span><span class="identifier">i</span><span>) =&gt; </span><span class="identifier">raw2Perft</span><span>(</span><span class="identifier">i</span><span>, </span><span class="identifier">x</span><span>))
      .</span><span class="identifier">intersperse</span><span>(</span><span class="string-literal">&quot;</span><span class="escape-sequence">\n</span><span class="string-literal">&quot;</span><span>)
      .</span><span class="identifier">through</span><span>(</span><span class="identifier">text</span><span>.</span><span class="identifier">utf8</span><span>.</span><span class="identifier">encode</span><span>)
      .</span><span class="identifier">through</span><span>(</span><span class="type-name">Files</span><span>[</span><span class="type-name">IO</span><span>].</span><span class="identifier">writeAll</span><span>(</span><span class="type-name">Path</span><span>(</span><span class="string-literal">&quot;chess960.perft&quot;</span><span>)))

  </span><span class="keyword">def</span><span> </span><span class="declaration-name">run</span><span>: </span><span class="type-name">IO</span><span>[</span><span class="type-name">Unit</span><span>] = </span><span class="identifier">converter</span><span>.</span><span class="identifier">compile</span><span>.</span><span class="identifier">drain</span></code></pre>
          </div>
          <div class="tab-content" data-choice-name="scala-2">
            <pre><code class="nohighlight"><span class="comment">//&gt; using lib &quot;org.typelevel::toolkit::0.0.11&quot;
</span><span>
</span><span class="keyword">import</span><span> </span><span class="identifier">cats</span><span>.</span><span class="identifier">effect</span><span>.{</span><span class="type-name">IO</span><span>, </span><span class="type-name">IOApp</span><span>}
</span><span class="keyword">import</span><span> </span><span class="identifier">fs2</span><span>.{</span><span class="type-name">Stream</span><span>, </span><span class="identifier">text</span><span>}
</span><span class="keyword">import</span><span> </span><span class="identifier">fs2</span><span>.</span><span class="identifier">io</span><span>.</span><span class="identifier">file</span><span>.{</span><span class="type-name">Files</span><span>, </span><span class="type-name">Path</span><span>}

</span><span class="keyword">object</span><span> </span><span class="type-name">PerftConverter</span><span> </span><span class="keyword">extends</span><span> </span><span class="type-name">IOApp</span><span>.</span><span class="type-name">Simple</span><span> {

  </span><span class="keyword">val</span><span> </span><span class="identifier">converter</span><span>: </span><span class="type-name">Stream</span><span>[</span><span class="type-name">IO</span><span>, </span><span class="type-name">Unit</span><span>] = {
    </span><span class="keyword">def</span><span> </span><span class="declaration-name">raw2Perft</span><span>(</span><span class="identifier">id</span><span>: </span><span class="type-name">Long</span><span>, </span><span class="identifier">raw</span><span>: </span><span class="type-name">String</span><span>): </span><span class="type-name">String</span><span> = {
      </span><span class="keyword">val</span><span> </span><span class="identifier">list</span><span> = </span><span class="identifier">raw</span><span>.</span><span class="identifier">split</span><span>(</span><span class="string-literal">&quot;;&quot;</span><span>).</span><span class="identifier">zipWithIndex</span><span>.</span><span class="identifier">map</span><span> {
        </span><span class="keyword">case</span><span> (</span><span class="identifier">epd</span><span>, </span><span class="number-literal">0</span><span>) =&gt; </span><span class="string-literal">s&quot;epd </span><span class="substitution">${epd}</span><span class="string-literal">&quot;</span><span>
        </span><span class="keyword">case</span><span> (</span><span class="identifier">s</span><span>, </span><span class="identifier">i</span><span>)   =&gt; </span><span class="string-literal">s&quot;perft </span><span class="substitution">$i</span><span class="string-literal"> </span><span class="substitution">${s.split(&quot; &quot;)(1)}</span><span class="string-literal">&quot;</span><span>
      }
      </span><span class="identifier">list</span><span>.</span><span class="identifier">mkString</span><span>(</span><span class="string-literal">s&quot;id </span><span class="substitution">$id</span><span class="escape-sequence">\n</span><span class="string-literal">&quot;</span><span>, </span><span class="string-literal">&quot;</span><span class="escape-sequence">\n</span><span class="string-literal">&quot;</span><span>, </span><span class="string-literal">&quot;</span><span class="escape-sequence">\n</span><span class="string-literal">&quot;</span><span>)
    }

    </span><span class="type-name">Files</span><span>[</span><span class="type-name">IO</span><span>]
      .</span><span class="identifier">readUtf8Lines</span><span>(</span><span class="type-name">Path</span><span>(</span><span class="string-literal">&quot;fischer.epd&quot;</span><span>))
      .</span><span class="identifier">filter</span><span>(</span><span class="identifier">s</span><span> =&gt; !</span><span class="identifier">s</span><span>.</span><span class="identifier">trim</span><span>.</span><span class="identifier">isEmpty</span><span>)
      .</span><span class="identifier">zipWithIndex</span><span>
      .</span><span class="identifier">map</span><span> { </span><span class="keyword">case</span><span> (</span><span class="identifier">x</span><span>, </span><span class="identifier">i</span><span>) =&gt; </span><span class="identifier">raw2Perft</span><span>(</span><span class="identifier">i</span><span>, </span><span class="identifier">x</span><span>) }
      .</span><span class="identifier">intersperse</span><span>(</span><span class="string-literal">&quot;</span><span class="escape-sequence">\n</span><span class="string-literal">&quot;</span><span>)
      .</span><span class="identifier">through</span><span>(</span><span class="identifier">text</span><span>.</span><span class="identifier">utf8</span><span>.</span><span class="identifier">encode</span><span>)
      .</span><span class="identifier">through</span><span>(</span><span class="type-name">Files</span><span>[</span><span class="type-name">IO</span><span>].</span><span class="identifier">writeAll</span><span>(</span><span class="type-name">Path</span><span>(</span><span class="string-literal">&quot;chess960.perft&quot;</span><span>)))
  }

  </span><span class="keyword">def</span><span> </span><span class="declaration-name">run</span><span>: </span><span class="type-name">IO</span><span>[</span><span class="type-name">Unit</span><span>] = </span><span class="identifier">converter</span><span>.</span><span class="identifier">compile</span><span>.</span><span class="identifier">drain</span><span>
}</span></code></pre>
          </div>
        </div>

        
<hr class="footer-rule"/>
<footer>
  toolkit is a <a href="https://typelevel.org/">Typelevel</a> project distributed under the <a href="https://www.apache.org/licenses/LICENSE-2.0.txt">Apache-2.0</a> license.
</footer>


      </main>

    </div>

  </body>

</html>